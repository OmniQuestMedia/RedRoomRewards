openapi: 3.0.3
info:
  title: RedRoomRewards API
  description: |
    **Canonical API Contract for RedRoomRewards Loyalty Platform**

    This contract defines all API endpoints for RedRoomRewards loyalty platform,
    aligned with the implemented core modules and business logic services.

    **Architecture Intent**:
    Ledger-based loyalty system managing user wallets, point earning/redemption,
    point expiration, model wallets, admin operations, and external webhook integrations.

    **Core Features**:
    - Immutable ledger with full audit trails
    - Escrow-based point holding for performance workflows
    - Queue-authorized settlements (no direct money mixing)
    - Optimistic locking for concurrency control
    - Point expiration with grace periods
    - Admin operations with full audit context

    **Security Requirements**:
    - All endpoints require JWT bearer authentication (except /health)
    - Idempotency keys mandatory for all state-changing operations
    - Request tracing via X-Request-ID header
    - Rate limiting enforced per endpoint
    - Queue operations require signed JWT tokens
    - Admin operations require role-based authorization

    **Idempotency**:
    - All POST operations accept X-Idempotency-Key header
    - Duplicate requests return cached responses (200 vs 201)
    - Idempotency keys prevent double-spend and duplicate operations
    - Request tampering detection (same key, different payload)

    **References**:
    - Architecture: /docs/UNIVERSAL_ARCHITECTURE.md
    - Security: /SECURITY.md
    - Testing: /docs/TESTING_STRATEGY.md
    - Database: /docs/DATABASE_SCHEMA.md

    **Work Order**: 2026-01-03 API contracts and test implementation
    **Status**: âœ… Aligned with core module implementation v0.2.0
  version: 0.2.0
  contact:
    name: RedRoomRewards Team
    url: https://github.com/OmniQuestMedia/RedRoomRewards

servers:
  - url: https://api.redroomrewards.example.com/v1
    description: Production server (placeholder)
  - url: https://staging-api.redroomrewards.example.com/v1
    description: Staging server (placeholder)
  - url: http://localhost:3000/v1
    description: Local development server (placeholder)

tags:
  - name: health
    description: Service health and status checks
  - name: wallets
    description: User wallet and balance operations
  - name: escrow
    description: Escrow hold, settlement, and refund operations
  - name: earn
    description: Point earning operations
  - name: redeem
    description: Point redemption operations
  - name: ledger
    description: Transaction history and audit trail
  - name: models
    description: Model-specific wallet operations
  - name: admin
    description: Administrative operations (restricted)
  - name: webhooks
    description: Webhook endpoints for external integrations

paths:
  # ===== Health & Status =====
  /health:
    get:
      summary: Health check
      description: Returns service health status
      operationId: getHealth
      tags:
        - health
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  # ===== Wallet Operations =====
  /wallets/{userId}:
    get:
      summary: Get user wallet
      description: Retrieve wallet balance and details for a user
      operationId: getUserWallet
      tags:
        - wallets
      parameters:
        - $ref: '#/components/parameters/UserIdPath'
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        '200':
          description: Wallet details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Wallet'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /wallets/{userId}/balance:
    get:
      summary: Get wallet balance
      description: Retrieve current balance only (lightweight)
      operationId: getWalletBalance
      tags:
        - wallets
      parameters:
        - $ref: '#/components/parameters/UserIdPath'
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        '200':
          description: Balance retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BalanceResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ===== Escrow Operations =====
  /wallets/{userId}/escrow/hold:
    post:
      summary: Hold funds in escrow
      description: |
        Deduct funds from user's available balance and place in escrow.
        This is the first step in the escrow flow. Requires idempotency key.

        **Authorization**: Feature modules can call this endpoint.
        **Next Step**: Feature must emit queue intake event.
      operationId: holdInEscrow
      tags:
        - escrow
      parameters:
        - $ref: '#/components/parameters/UserIdPath'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/RequestIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EscrowHoldRequest'
      responses:
        '201':
          description: Funds held in escrow successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EscrowHoldResponse'
        '200':
          description: Duplicate request - returning cached result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EscrowHoldResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '402':
          description: Insufficient available balance
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /wallets/escrow/{escrowId}/settle:
    post:
      summary: Settle escrow to model earnings
      description: |
        Transfer funds from escrow to model's earned balance.

        **Authorization**: ONLY Performance Queue can call this endpoint.
        Requires valid queue authorization token in header.

        This completes the escrow flow for successful performance.
      operationId: settleEscrow
      tags:
        - escrow
      parameters:
        - name: escrowId
          in: path
          required: true
          description: Escrow identifier
          schema:
            type: string
        - name: X-Queue-Auth-Token
          in: header
          required: true
          description: Queue authorization token (signed JWT)
          schema:
            type: string
            format: jwt
            pattern: '^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/RequestIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EscrowSettleRequest'
      responses:
        '200':
          description: Escrow settled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EscrowSettleResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Invalid queue authorization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Escrow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Escrow already processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /wallets/escrow/{escrowId}/refund:
    post:
      summary: Refund escrow to user
      description: |
        Return funds from escrow to user's available balance.

        **Authorization**: ONLY Performance Queue can call this endpoint.
        Requires valid queue authorization token in header.

        This completes the escrow flow for cancelled/abandoned performance.
      operationId: refundEscrow
      tags:
        - escrow
      parameters:
        - name: escrowId
          in: path
          required: true
          description: Escrow identifier
          schema:
            type: string
        - name: X-Queue-Auth-Token
          in: header
          required: true
          description: Queue authorization token (signed JWT)
          schema:
            type: string
            format: jwt
            pattern: '^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/RequestIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EscrowRefundRequest'
      responses:
        '200':
          description: Escrow refunded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EscrowRefundResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Invalid queue authorization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Escrow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Escrow already processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /wallets/escrow/{escrowId}/partial-settle:
    post:
      summary: Partial settlement (refund + settle)
      description: |
        Split escrow funds between refund to user and settlement to model.
        Used for partial performance or quality issues.

        **Authorization**: ONLY Performance Queue can call this endpoint.
        Requires valid queue authorization token in header.

        refundAmount + settleAmount must equal original escrow amount.
      operationId: partialSettleEscrow
      tags:
        - escrow
      parameters:
        - name: escrowId
          in: path
          required: true
          description: Escrow identifier
          schema:
            type: string
        - name: X-Queue-Auth-Token
          in: header
          required: true
          description: Queue authorization token (signed JWT)
          schema:
            type: string
            format: jwt
            pattern: '^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/RequestIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EscrowPartialSettleRequest'
      responses:
        '200':
          description: Partial settlement completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EscrowPartialSettleResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Invalid queue authorization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Escrow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Escrow already processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /wallets/{userId}/escrow:
    get:
      summary: Get user's escrow items
      description: |
        Retrieve all escrow items for a user, showing pending holds,
        settled items, and refunded items.
      operationId: getUserEscrow
      tags:
        - escrow
      parameters:
        - $ref: '#/components/parameters/UserIdPath'
        - name: status
          in: query
          description: Filter by escrow status
          schema:
            type: string
            enum: [held, settled, refunded, all]
            default: all
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        '200':
          description: Escrow items retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EscrowDetailsResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ===== Earn Operations =====
  /earn:
    post:
      summary: Award points to user
      description: |
        Credit points to a user's wallet. This endpoint is idempotent and
        requires an idempotency key to prevent duplicate awards.

        **Examples**:
        - Signup bonus: Award 100 points to new user
        - Referral: Award 50 points for successful referral
        - Promotional: Award points with expiration date
      operationId: earnPoints
      tags:
        - earn
      parameters:
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/RequestIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EarnRequest'
            examples:
              signup_bonus:
                summary: Signup bonus award
                value:
                  userId: "user-123"
                  amount: 100
                  reason: "user_signup_bonus"
                  metadata:
                    campaign: "new_user_2026"
              referral:
                summary: Referral bonus
                value:
                  userId: "user-456"
                  amount: 50
                  reason: "referral_bonus"
                  metadata:
                    referredBy: "user-123"
              promotional:
                summary: Promotional points with expiration
                value:
                  userId: "user-789"
                  amount: 500
                  reason: "promotional_campaign"
                  metadata:
                    campaign: "holiday_2026"
                    expiresAt: "2026-12-31T23:59:59Z"
      responses:
        '201':
          description: Points awarded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResponse'
              examples:
                success:
                  summary: Successful point award
                  value:
                    transaction:
                      id: "txn-abc123"
                      userId: "user-123"
                      amount: 100
                      type: "credit"
                      reason: "user_signup_bonus"
                      timestamp: "2026-01-03T12:00:00Z"
                      idempotencyKey: "idem-key-123"
                      previousBalance: 0
                      newBalance: 100
                      requestId: "req-xyz789"
                    wallet:
                      userId: "user-123"
                      availableBalance: 100
                      escrowBalance: 0
                      totalBalance: 100
                      currency: "points"
                      version: 1
        '200':
          description: Duplicate request - returning cached result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  # ===== Redeem Operations =====
  /redeem:
    post:
      summary: Redeem points from user
      description: |
        Debit points from a user's wallet. This endpoint is idempotent and
        requires an idempotency key to prevent duplicate redemptions.

        **Note**: This creates an escrow hold. Actual settlement to model
        is performed by the queue service after performance completion.
      operationId: redeemPoints
      tags:
        - redeem
      parameters:
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/RequestIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RedeemRequest'
            examples:
              chip_menu:
                summary: Chip menu action redemption
                value:
                  userId: "user-123"
                  amount: 100
                  reason: "chip_menu_purchase"
                  metadata:
                    featureType: "chip_menu"
                    queueItemId: "queue-abc123"
                    modelId: "model-456"
                    action: "dance"
              slot_machine:
                summary: Slot machine play
                value:
                  userId: "user-789"
                  amount: 50
                  reason: "slot_machine_play"
                  metadata:
                    featureType: "slot_machine"
                    queueItemId: "queue-xyz789"
      responses:
        '201':
          description: Points redeemed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResponse'
              examples:
                success:
                  summary: Successful redemption (escrow hold)
                  value:
                    transaction:
                      id: "txn-def456"
                      userId: "user-123"
                      amount: -100
                      type: "debit"
                      reason: "chip_menu_purchase"
                      timestamp: "2026-01-03T12:05:00Z"
                      idempotencyKey: "idem-key-456"
                      previousBalance: 500
                      newBalance: 400
                      requestId: "req-abc123"
                    wallet:
                      userId: "user-123"
                      availableBalance: 400
                      escrowBalance: 100
                      totalBalance: 500
                      currency: "points"
                      version: 5
        '200':
          description: Duplicate request - returning cached result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '402':
          description: Insufficient balance
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                insufficient_balance:
                  summary: User has insufficient balance
                  value:
                    error: "INSUFFICIENT_BALANCE"
                    message: "User has insufficient available balance for this redemption"
                    details:
                      required: 100
                      available: 50
                    requestId: "req-abc123"
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  # ===== Ledger Operations =====
  /ledger/transactions:
    get:
      summary: List transactions
      description: Retrieve transaction history with filtering and pagination
      operationId: listTransactions
      tags:
        - ledger
      parameters:
        - $ref: '#/components/parameters/RequestIdHeader'
        - name: userId
          in: query
          description: Filter by user ID
          schema:
            type: string
        - name: type
          in: query
          description: Filter by transaction type
          schema:
            type: string
            enum: [credit, debit, all]
        - name: startDate
          in: query
          description: Filter transactions after this date (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          description: Filter transactions before this date (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          description: Maximum number of results (max 1000)
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
        - name: offset
          in: query
          description: Pagination offset
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: Transaction list retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /ledger/transactions/{transactionId}:
    get:
      summary: Get transaction details
      description: Retrieve details of a specific transaction
      operationId: getTransaction
      tags:
        - ledger
      parameters:
        - name: transactionId
          in: path
          required: true
          description: Transaction identifier
          schema:
            type: string
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        '200':
          description: Transaction details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ===== Model Operations =====
  /models/{modelId}/wallet:
    get:
      summary: Get model wallet
      description: Retrieve promotional wallet for a model
      operationId: getModelWallet
      tags:
        - models
      parameters:
        - name: modelId
          in: path
          required: true
          description: Model identifier
          schema:
            type: string
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        '200':
          description: Model wallet retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelWallet'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /models/{modelId}/earn:
    post:
      summary: Award points to model
      description: Credit points to model's promotional wallet
      operationId: modelEarnPoints
      tags:
        - models
      parameters:
        - name: modelId
          in: path
          required: true
          description: Model identifier
          schema:
            type: string
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/RequestIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModelEarnRequest'
      responses:
        '201':
          description: Points awarded to model
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResponse'
        '200':
          description: Duplicate request - cached result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ===== Admin Operations =====
  /admin/wallets:
    post:
      summary: Create wallet (admin)
      description: Manually create a wallet for a user or model
      operationId: adminCreateWallet
      tags:
        - admin
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/RequestIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWalletRequest'
      responses:
        '201':
          description: Wallet created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Wallet'
        '200':
          description: Duplicate request - wallet exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Wallet'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/adjustments:
    post:
      summary: Manual point adjustment (admin)
      description: |
        Manually credit or debit points from a user wallet.
        Requires admin authorization and creates full audit trail.
        Amount can be positive (credit) or negative (debit).
      operationId: adminManualAdjustment
      tags:
        - admin
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/RequestIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminAdjustmentRequest'
      responses:
        '201':
          description: Adjustment completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminAdjustmentResponse'
        '200':
          description: Duplicate request - returning cached result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminAdjustmentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/refunds:
    post:
      summary: Process admin refund
      description: |
        Issue a refund to a user account. Creates audit trail and
        optionally references original transaction.
      operationId: adminProcessRefund
      tags:
        - admin
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/RequestIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminRefundRequest'
      responses:
        '201':
          description: Refund processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminRefundResponse'
        '200':
          description: Duplicate request - returning cached result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminRefundResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/transactions/{transactionId}/audit:
    get:
      summary: Get full audit trail (admin)
      description: Retrieve complete audit information for a transaction
      operationId: adminGetAuditTrail
      tags:
        - admin
      security:
        - bearerAuth: []
      parameters:
        - name: transactionId
          in: path
          required: true
          description: Transaction identifier
          schema:
            type: string
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        '200':
          description: Audit trail retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditTrail'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/expiration/process:
    post:
      summary: Process point expirations (admin)
      description: |
        Manually trigger batch expiration processing for expired points.
        Typically run by scheduled jobs but can be triggered manually.
      operationId: adminProcessExpiration
      tags:
        - admin
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/RequestIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExpirationProcessRequest'
      responses:
        '200':
          description: Expiration processing completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExpirationBatchResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/expiration/warnings:
    get:
      summary: Get users with expiring points (admin)
      description: |
        Retrieve list of users with points expiring soon.
        Used for notification systems.
      operationId: adminGetExpirationWarnings
      tags:
        - admin
      security:
        - bearerAuth: []
      parameters:
        - name: daysAhead
          in: query
          description: Number of days ahead to check for expirations
          schema:
            type: integer
            default: 7
            minimum: 1
            maximum: 90
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        '200':
          description: List of users with expiring points
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExpirationWarningsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ===== Webhook Endpoints =====
  /webhooks/external/award:
    post:
      summary: External award webhook
      description: |
        Webhook endpoint for external systems to award points.
        Requires webhook signature verification.
      operationId: webhookExternalAward
      tags:
        - webhooks
      parameters:
        - name: X-Webhook-Signature
          in: header
          required: true
          description: HMAC signature for webhook verification
          schema:
            type: string
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
        - $ref: '#/components/parameters/RequestIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookAwardPayload'
      responses:
        '202':
          description: Webhook accepted and queued for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
        '200':
          description: Duplicate webhook - already processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Invalid webhook signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  # ===== Parameters =====
  parameters:
    UserIdPath:
      name: userId
      in: path
      required: true
      description: User identifier
      schema:
        type: string
        pattern: '^[a-zA-Z0-9_-]+$'
        minLength: 1
        maxLength: 128

    IdempotencyKeyHeader:
      name: X-Idempotency-Key
      in: header
      required: true
      description: Unique key for idempotent operations (UUID recommended)
      schema:
        type: string
        format: uuid
        minLength: 1
        maxLength: 255

    RequestIdHeader:
      name: X-Request-ID
      in: header
      required: false
      description: Request tracing identifier (auto-generated if not provided)
      schema:
        type: string
        format: uuid

  # ===== Schemas =====
  schemas:
    # Health
    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [ok, degraded, error]
          example: ok
        timestamp:
          type: string
          format: date-time
        version:
          type: string
          example: 0.1.0
        uptime:
          type: integer
          description: Uptime in seconds

    # Wallet schemas
    Wallet:
      type: object
      required:
        - userId
        - availableBalance
        - escrowBalance
        - currency
        - version
      properties:
        userId:
          type: string
          description: User identifier
        availableBalance:
          type: number
          format: double
          description: Points available for spending
        escrowBalance:
          type: number
          format: double
          description: Points held in escrow
        totalBalance:
          type: number
          format: double
          description: Total balance (available + escrow)
        currency:
          type: string
          description: Currency type
          default: points
          example: points
        createdAt:
          type: string
          format: date-time
        lastUpdated:
          type: string
          format: date-time
        version:
          type: integer
          description: Optimistic locking version
          minimum: 0

    BalanceResponse:
      type: object
      required:
        - userId
        - available
        - escrow
        - total
      properties:
        userId:
          type: string
        available:
          type: number
          format: double
          description: Available balance for spending
        escrow:
          type: number
          format: double
          description: Balance held in escrow
        total:
          type: number
          format: double
          description: Total balance (available + escrow)
        asOf:
          type: string
          format: date-time

    ModelWallet:
      type: object
      required:
        - modelId
        - balance
        - currency
        - type
      properties:
        modelId:
          type: string
        balance:
          type: number
          format: double
        currency:
          type: string
          default: points
        type:
          type: string
          enum: [promotional, earnings]
          description: Wallet type for models
        createdAt:
          type: string
          format: date-time
        lastUpdated:
          type: string
          format: date-time

    # Transaction schemas
    Transaction:
      type: object
      required:
        - id
        - userId
        - amount
        - type
        - reason
        - timestamp
        - idempotencyKey
      properties:
        id:
          type: string
          description: Unique transaction identifier
        userId:
          type: string
        amount:
          type: number
          format: double
          description: Transaction amount (positive for credit, negative for debit)
        type:
          type: string
          enum: [credit, debit]
        reason:
          type: string
          description: Reason code for transaction
          example: user_signup_bonus
        metadata:
          type: object
          additionalProperties: true
          description: Additional context data
        timestamp:
          type: string
          format: date-time
        idempotencyKey:
          type: string
          description: Idempotency key used for this transaction
        previousBalance:
          type: number
          format: double
        newBalance:
          type: number
          format: double
        requestId:
          type: string
          description: Request ID for tracing

    TransactionResponse:
      type: object
      required:
        - transaction
        - wallet
      properties:
        transaction:
          $ref: '#/components/schemas/Transaction'
        wallet:
          $ref: '#/components/schemas/Wallet'

    TransactionListResponse:
      type: object
      required:
        - transactions
        - pagination
      properties:
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/Transaction'
        pagination:
          $ref: '#/components/schemas/Pagination'

    # Request schemas
    EarnRequest:
      type: object
      required:
        - userId
        - amount
        - reason
      properties:
        userId:
          type: string
        amount:
          type: number
          format: double
          minimum: 0.01
          description: Points to award (must be positive)
        reason:
          type: string
          minLength: 1
          maxLength: 255
          description: Reason code for awarding points
        metadata:
          type: object
          additionalProperties: true
          description: Optional metadata for audit trail

    RedeemRequest:
      type: object
      required:
        - userId
        - amount
        - reason
      properties:
        userId:
          type: string
        amount:
          type: number
          format: double
          minimum: 0.01
          description: Points to redeem (must be positive)
        reason:
          type: string
          minLength: 1
          maxLength: 255
          description: Reason code for redemption
        metadata:
          type: object
          additionalProperties: true

    ModelEarnRequest:
      type: object
      required:
        - amount
        - reason
      properties:
        amount:
          type: number
          format: double
          minimum: 0.01
        reason:
          type: string
          minLength: 1
          maxLength: 255
        metadata:
          type: object
          additionalProperties: true

    CreateWalletRequest:
      type: object
      required:
        - userId
        - currency
      properties:
        userId:
          type: string
        currency:
          type: string
          default: points
        initialBalance:
          type: number
          format: double
          default: 0
          description: Starting balance (default 0)

    # Escrow schemas
    EscrowHoldRequest:
      type: object
      required:
        - amount
        - reason
        - queueItemId
        - featureType
      properties:
        amount:
          type: number
          format: double
          minimum: 0.01
          description: Amount to hold in escrow
        reason:
          type: string
          minLength: 1
          maxLength: 255
          description: Transaction reason code
          example: chip_menu_purchase
        queueItemId:
          type: string
          description: Performance queue item ID
        featureType:
          type: string
          description: Feature initiating the hold
          example: chip_menu
        metadata:
          type: object
          additionalProperties: true
          description: Additional context (no PII)

    EscrowHoldResponse:
      type: object
      required:
        - transactionId
        - escrowId
        - previousBalance
        - newAvailableBalance
        - escrowBalance
        - timestamp
      properties:
        transactionId:
          type: string
          description: Created transaction identifier
        escrowId:
          type: string
          description: Created escrow identifier
        previousBalance:
          type: number
          format: double
          description: User's previous available balance
        newAvailableBalance:
          type: number
          format: double
          description: User's new available balance
        escrowBalance:
          type: number
          format: double
          description: Amount now in escrow
        timestamp:
          type: string
          format: date-time

    EscrowSettleRequest:
      type: object
      required:
        - modelId
        - amount
        - queueItemId
        - reason
      properties:
        modelId:
          type: string
          description: Model to credit
        amount:
          type: number
          format: double
          minimum: 0.01
          description: Amount to settle (must match escrow)
        queueItemId:
          type: string
          description: Performance queue item ID
        reason:
          type: string
          minLength: 1
          maxLength: 255
          description: Settlement reason code
          example: performance_completed
        metadata:
          type: object
          additionalProperties: true

    EscrowSettleResponse:
      type: object
      required:
        - transactionId
        - settledAmount
        - modelEarnedBalance
        - timestamp
      properties:
        transactionId:
          type: string
          description: Settlement transaction ID
        settledAmount:
          type: number
          format: double
          description: Amount settled to model
        modelEarnedBalance:
          type: number
          format: double
          description: Model's new earned balance
        timestamp:
          type: string
          format: date-time

    EscrowRefundRequest:
      type: object
      required:
        - userId
        - amount
        - queueItemId
        - reason
      properties:
        userId:
          type: string
          description: User to refund
        amount:
          type: number
          format: double
          minimum: 0.01
          description: Amount to refund (must match escrow)
        queueItemId:
          type: string
          description: Performance queue item ID
        reason:
          type: string
          minLength: 1
          maxLength: 255
          description: Refund reason code
          example: performance_abandoned
        metadata:
          type: object
          additionalProperties: true

    EscrowRefundResponse:
      type: object
      required:
        - transactionId
        - refundedAmount
        - userAvailableBalance
        - timestamp
      properties:
        transactionId:
          type: string
          description: Refund transaction ID
        refundedAmount:
          type: number
          format: double
          description: Amount refunded to user
        userAvailableBalance:
          type: number
          format: double
          description: User's new available balance
        timestamp:
          type: string
          format: date-time

    EscrowPartialSettleRequest:
      type: object
      required:
        - userId
        - modelId
        - refundAmount
        - settleAmount
        - queueItemId
        - reason
      properties:
        userId:
          type: string
          description: User to refund partial amount
        modelId:
          type: string
          description: Model to settle remaining amount
        refundAmount:
          type: number
          format: double
          minimum: 0
          description: Amount to refund to user
        settleAmount:
          type: number
          format: double
          minimum: 0
          description: Amount to settle to model
        queueItemId:
          type: string
          description: Performance queue item ID
        reason:
          type: string
          minLength: 1
          maxLength: 255
          description: Partial settlement reason code
          example: partial_performance
        metadata:
          type: object
          additionalProperties: true

    EscrowPartialSettleResponse:
      type: object
      required:
        - transactionId
        - refundedAmount
        - settledAmount
        - userAvailableBalance
        - modelEarnedBalance
        - timestamp
      properties:
        transactionId:
          type: string
          description: Partial settlement transaction ID
        refundedAmount:
          type: number
          format: double
          description: Amount refunded to user
        settledAmount:
          type: number
          format: double
          description: Amount settled to model
        userAvailableBalance:
          type: number
          format: double
          description: User's new available balance
        modelEarnedBalance:
          type: number
          format: double
          description: Model's new earned balance
        timestamp:
          type: string
          format: date-time

    EscrowDetailsResponse:
      type: object
      required:
        - userId
        - escrowItems
        - totalEscrow
      properties:
        userId:
          type: string
        escrowItems:
          type: array
          items:
            $ref: '#/components/schemas/EscrowItem'
        totalEscrow:
          type: number
          format: double
          description: Total amount in escrow

    EscrowItem:
      type: object
      required:
        - escrowId
        - amount
        - status
        - queueItemId
        - featureType
        - createdAt
      properties:
        escrowId:
          type: string
        amount:
          type: number
          format: double
        status:
          type: string
          enum: [held, settled, refunded]
        queueItemId:
          type: string
        featureType:
          type: string
        reason:
          type: string
        metadata:
          type: object
          additionalProperties: true
        createdAt:
          type: string
          format: date-time
        processedAt:
          type: string
          format: date-time
          description: When settled or refunded (null if still held)
        modelId:
          type: string
          description: Model ID if settled

    WebhookAwardPayload:
      type: object
      required:
        - event
        - userId
        - amount
        - reason
      properties:
        event:
          type: string
          description: Event type from external system
        userId:
          type: string
        amount:
          type: number
          format: double
          minimum: 0.01
        reason:
          type: string
        timestamp:
          type: string
          format: date-time
        metadata:
          type: object
          additionalProperties: true

    # Admin schemas
    AdminAdjustmentRequest:
      type: object
      required:
        - userId
        - amount
        - reason
        - adminContext
      properties:
        userId:
          type: string
          description: User to adjust
        amount:
          type: number
          format: double
          description: Amount to adjust (positive for credit, negative for debit)
        reason:
          type: string
          minLength: 1
          maxLength: 500
          description: Detailed reason for adjustment
        adminContext:
          $ref: '#/components/schemas/AdminContext'
        metadata:
          type: object
          additionalProperties: true
          description: Additional context (no PII)

    AdminAdjustmentResponse:
      type: object
      required:
        - transactionId
        - amountAdjusted
        - previousBalance
        - newBalance
        - timestamp
      properties:
        transactionId:
          type: string
        amountAdjusted:
          type: number
          format: double
        previousBalance:
          type: number
          format: double
        newBalance:
          type: number
          format: double
        timestamp:
          type: string
          format: date-time

    AdminRefundRequest:
      type: object
      required:
        - userId
        - amount
        - reason
        - adminContext
      properties:
        userId:
          type: string
          description: User to refund
        amount:
          type: number
          format: double
          minimum: 0.01
          description: Amount to refund (must be positive)
        reason:
          type: string
          minLength: 1
          maxLength: 500
          description: Reason for refund
        referenceTransactionId:
          type: string
          description: Optional reference to original transaction
        adminContext:
          $ref: '#/components/schemas/AdminContext'
        metadata:
          type: object
          additionalProperties: true

    AdminRefundResponse:
      type: object
      required:
        - transactionId
        - amountRefunded
        - newBalance
        - timestamp
      properties:
        transactionId:
          type: string
        amountRefunded:
          type: number
          format: double
        newBalance:
          type: number
          format: double
        timestamp:
          type: string
          format: date-time

    AdminContext:
      type: object
      required:
        - adminId
        - adminUsername
        - roles
      properties:
        adminId:
          type: string
          description: Admin user ID
        adminUsername:
          type: string
          description: Admin username/email
        roles:
          type: array
          items:
            type: string
          description: Admin roles
        ipAddress:
          type: string
          description: IP address of admin
        userAgent:
          type: string
          description: User agent string

    ExpirationProcessRequest:
      type: object
      properties:
        batchSize:
          type: integer
          default: 100
          minimum: 1
          maximum: 1000
          description: Number of users to process in batch
        dryRun:
          type: boolean
          default: false
          description: If true, only report what would be expired

    ExpirationBatchResult:
      type: object
      required:
        - usersProcessed
        - totalPointsExpired
        - successCount
        - failureCount
        - timestamp
      properties:
        usersProcessed:
          type: integer
          description: Number of users processed
        totalPointsExpired:
          type: number
          format: double
          description: Total points expired across all users
        successCount:
          type: integer
          description: Number of successful expirations
        failureCount:
          type: integer
          description: Number of failed expirations
        timestamp:
          type: string
          format: date-time
        errors:
          type: array
          items:
            type: object
            properties:
              userId:
                type: string
              error:
                type: string

    ExpirationWarningsResponse:
      type: object
      required:
        - users
        - totalUsers
        - totalPointsExpiring
      properties:
        users:
          type: array
          items:
            $ref: '#/components/schemas/UserExpirationWarning'
        totalUsers:
          type: integer
          description: Total number of users with expiring points
        totalPointsExpiring:
          type: number
          format: double
          description: Total points expiring across all users

    UserExpirationWarning:
      type: object
      required:
        - userId
        - pointsExpiring
        - expirationDate
      properties:
        userId:
          type: string
        pointsExpiring:
          type: number
          format: double
        expirationDate:
          type: string
          format: date-time
        daysUntilExpiration:
          type: integer

    AuditTrail:
      type: object
      required:
        - transaction
        - auditLog
      properties:
        transaction:
          $ref: '#/components/schemas/Transaction'
        auditLog:
          type: object
          properties:
            createdBy:
              type: string
            ipAddress:
              type: string
            userAgent:
              type: string
            additionalContext:
              type: object
              additionalProperties: true

    # Webhook responses
    WebhookResponse:
      type: object
      required:
        - accepted
        - requestId
      properties:
        accepted:
          type: boolean
        requestId:
          type: string
        queueId:
          type: string
          description: Queue identifier for async processing

    # Common schemas
    Pagination:
      type: object
      required:
        - limit
        - offset
        - total
      properties:
        limit:
          type: integer
        offset:
          type: integer
        total:
          type: integer
          description: Total number of items
        hasMore:
          type: boolean

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          additionalProperties: true
          description: Additional error context
        requestId:
          type: string
          description: Request ID for tracing

  # ===== Responses =====
  responses:
    BadRequest:
      description: Invalid request parameters or body
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Unauthorized:
      description: Missing or invalid authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Forbidden:
      description: Insufficient permissions for this operation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    UnprocessableEntity:
      description: Request understood but cannot be processed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  # ===== Security Schemes =====
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT bearer token for authentication. Include in Authorization header:
        `Authorization: Bearer <token>`

# ===== Global Security =====
security:
  - bearerAuth: []
